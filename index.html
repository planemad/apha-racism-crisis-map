<head>
  <script src="./states-data.js"></script>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css" rel="stylesheet" />
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

  <link href="app.css" rel="stylesheet" />

  <script src="https://unpkg.com/geojson@0.5.0/geojson.min.js"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>

  <style>
    body {
      margin: 0;
    }

    article {
      margin: 200px auto;
      position: relative;
      width: 800px;
      border: 1px solid #eaeaea
    }

    section {
      position: relative;
    }


    #map {
      height: 70vh;
      width: 100%;
    }

    #map-filter {

      z-index: 10;
      padding: 10px;
      color: grey;
      background-color: aliceblue;
      width: 100%;
    }

    .filter h6 {
      margin-right: 10px;
    }

    .filter {
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    .filter input {
      margin: inherit;
    }

    #map-overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      padding: 10px;
      color: grey;
      background-color: rgba(240, 248, 255, 0.76);
      width: 30%;
    }

    .mapboxgl-popup-content a {
      text-decoration: underline;
      color: blue;
    }
  </style>
</head>

<body>


  <article>
    <h1 class="page-title">Declarations of Racism as a Public Health Crisis</h1>
    <p>Across the country, local and state leaders are declaring racism a public health crisis or emergency. These
      declarations are an important first step in the movement to advance racial equity and justice and must be followed
      by allocation of resources and strategic action.
    </p>

    <h4>Map of declarations</h2>

      <section>
        <div class="legend">
        </div>
        <div id="map"></div>

        <div id="map-filter">
          <div id="filter" class="filter">
          </div>
          <hr>
          <div id="subfilter" class="filter">
          </div>
        </div>

        <div id="map-overlay">
          <div>
            <label for="states">Select State:</label>

            <select name="states" id="state">
            </select>
          </div>

          <div id="declarations">

          </div>
        </div>

        </div>



      </section>


  </article>

  <script>
    //
    // Settings
    //


    // Map
    mapboxgl.accessToken = 'pk.eyJ1IjoicGxhbmVtYWQiLCJhIjoiemdYSVVLRSJ9.g3lbg_eN0kztmsfIPxa9MQ';

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/planemad/ckgd3vmjp17yp19s927o8bior',
      center: [-100, 40],
      zoom: 2
    });

    // Define map bounds 
    var bounds = [
      [-200, -10], // [west, south]
      [-30, 80] // [east, north]
    ];

    // Set the map's max bounds.
    map.setMaxBounds(bounds);

    // Spreadsheet
    let sheetId = "1eaU9tGMa7xwGGb6wpDP3T7w7Gw23NnLHGl4YoLILiHg";
    let sheetName = "All";

    let sheetData = null;
    filteredData = null;

    //
    //  Map logic
    //

    map.on("load", function () {

      loadMapLayers();
      addMapInteractions();

    });

    //
    // Map style
    //

    function loadMapLayers() {


      map.addLayer({
        'id': 'US states outline',
        'type': 'line',
        'source': 'composite',
        'source-layer': 'boundaries_admin_1',
        'layout': {},
        'paint': {
          'line-width': 0.5,
          'line-color': [
            'case',
            ['boolean', ['feature-state', 'focus'], false],
            "hsl(207, 64%, 58%)",
            ['boolean', ['feature-state', 'hover'], false],
            "hsl(207, 64%, 58%)",
            'rgba(0,0,0,0)'
          ]
        },
        'filter': ["all", [
          "any",
          [
            "==",
            "all",
            ["get", "worldview"]
          ],
          [
            "in",
            "US",
            ["get", "worldview"]
          ]
        ],
          [
            "==",
            "US",
            ["get", "iso_3166_1"]
          ]
        ]
      });

      map.setPaintProperty("US-states-fill", "fill-color", [
        "case",
        [
          "!=",
          null,
          ["feature-state", "count"]
        ],
        [
          "interpolate",
          ["linear"],
          [
            "feature-state",
            "count"
          ],
          1,
          "#feffc9",
          30,
          "#ff9700"
        ],
        "#efefef"
      ])

      // Location points

      map.addSource('locations', {
        type: 'geojson',
        'data': null
      });

      // Load spreadsheet
      loadSheetData();

    }


    function loadSheetData() {

      // console.log(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`)
      d3.text(`https://docs.google.com/spreadsheets/d/e/2PACX-1vRkLVhZFb2K0K9LWxxrZujKaGP1qcpsbZ9gCtAfM6eHGZuNa_qxBHwKpSPYfAiPSoMChphBJsMd4o7Z/pub?gid=1592883182&single=true&output=csv`)
        .then(function (data) {

          // data = d3.csvParse(data)
          data = d3.csvParse(data.split('\n').slice(5).join('\n'))

          // DEBUG
          // console.log(data)

          sheetData = data;

          // Convert rows into a geojson and add as points
          const geojson = GeoJSON.parse(data, {
            Point: ['Latitude', 'Longitude']
          });

          // Replace source in these style layers with the geojson
          setLayerSource("~locations", "locations")

          map.getSource('locations').setData(geojson)

          var bounds = turf.bbox(geojson);
          map.fitBounds(bounds, {
            padding: 100
          });

          document.getElementById('filter').insertAdjacentHTML('beforeend', '<h6>Explore by institution type:</h6>');

          // Aggregate rows by type
          var typesData = d3.group(data, d => d.Type)

          const radio =
            `<input checked type="radio" id="All" name="filter" value="All" onchange="updateSubfilters()"><label for="All">All levels (${data.length})</label>`

          document.getElementById('filter').insertAdjacentHTML('beforeend', radio);

          typesData.forEach((d, i) => {
            const radio =
              `<input type="radio" id="${i}" name="filter" value="${i}" onchange="updateSubfilters()"><label for="${i}">${i} (${d.length})</label>`

            document.getElementById('filter').insertAdjacentHTML('beforeend', radio);
          })

          // Updates the map using the selected filter
          updateSubfilters()

        })
    }

    //
    // Filter interface
    //

    function updateSubfilters() {

      let category = document.querySelector('input[name="filter"]:checked').value;

      let categoryTypeData = sheetData.filter(d => category == "All" ? true : d.Type == category)

      document.getElementById('subfilter').innerHTML = ``

      // Aggregate rows by subtype
      var subTypesData = d3.group(categoryTypeData, d => d["Sub-Type"])
      subTypesData.forEach((d, i) => {
        const checkbox =
          `<input checked type="checkbox" id="${i}" name="subfilter" value="${i}" onchange="filterData()"><label for="${i}">${i} (${d.length})</label>`

        document.getElementById('subfilter').insertAdjacentHTML('beforeend', checkbox);
      })

      filterData();

    }

    function filterData() {

      // Get the current filter values
      let type = document.querySelector('input[name="filter"]:checked').value;
      let subtypes = [];
      document.querySelectorAll('input[name="subfilter"]:checked').forEach(d => subtypes.push(d.value))

      subtypes = subtypes.length ? subtypes : ["None"]

      let layerFilter = ["all",
        [
          "match",
          ["get", "Type"],
          [type],
          true,
          type == "All" ? true : false
        ],
        [
          "match",
          ["get", "Sub-Type"],
          subtypes,
          true,
          false
        ]
      ]

      let layerOpacity = [
        "case",
        layerFilter,
        1,
        0.1
      ]

      map.setPaintProperty("locations", "circle-opacity", layerOpacity)


      let layerSortkey = [
        "case",
        ["all", [
          "match",
          ["get", "Type"],
          [type],
          true,
          type == "All" ? true : false
        ],
          [
            "match",
            ["get", "Sub-Type"],
            subtypes,
            true,
            false
          ]
        ],
        1,
        99
      ]

      map.setFilter("locations-label", layerFilter)
      map.setLayoutProperty("locations-label", "symbol-sort-key", layerSortkey)

      // Update choropleth

      // Filter the data

      filteredData = sheetData.filter(d => (type == "All" || d.Type == type) && subtypes.indexOf(d["Sub-Type"]) > -1)

      // Aggregate rows by state and join to boundaries
      var statesData = d3.group(filteredData, d => d.State)

      map.removeFeatureState({
        'source': 'composite',
        'sourceLayer': 'boundaries_admin_1'
      });

      // Iterate over entries for each state
      statesData.forEach((d, i) => {

        map.setFeatureState({
          'source': 'composite',
          'sourceLayer': 'boundaries_admin_1',
          id: statesLookup[i].boundary_id
        }, {
          count: d.length,
          name: statesLookup[i].name,
          code: statesLookup[i].code
        });

      })

    }

    //
    // Map Interactions
    //

    function addMapInteractions() {

      map.on('mousemove', 'US-states-fill', createStatePopup);
      map.on('mouseleave', 'US-states-fill', removeStatePopup);

      map.on('click', 'locations', createLocationPopup)
      map.on('click', 'locations-label', createLocationPopup)
      map.on('click', 'US-states-fill', focusState);

    }

    var hoverId = null;

    function createStatePopup(e) {

      map.getCanvas().style.cursor = 'pointer';

      if (e.features.length > 0) {
        if (hoverId) {
          map.setFeatureState({
            'source': 'composite',
            'sourceLayer': 'boundaries_admin_1',
            id: hoverId
          }, {
            hover: false
          });
        }
        hoverId = e.features[0].id;
        map.setFeatureState({
          'source': 'composite',
          'sourceLayer': 'boundaries_admin_1',
          id: hoverId
        }, {
          hover: true
        });
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      if (statePopupHTML(e.features[0]) !== "none") {

        document.getElementById('declarations').innerHTML = statePopupHTML(e.features[0]);

      } else {
        document.getElementById('declarations').innerHTML = "No declarations in state"
      }
    }

    function removeStatePopup() {
      map.getCanvas().style.cursor = '';

      if (hoverId) {
        map.setFeatureState({
          'source': 'composite',
          'sourceLayer': 'boundaries_admin_1',
          id: hoverId
        }, {
          hover: false
        });
      }
      hoverId = null;

    }

    var focusId = null;

    function focusState(e) {

      if (e.features.length > 0) {

        if (focusId) {
          map.setFeatureState({
            'source': 'composite',
            'sourceLayer': 'boundaries_admin_1',
            id: focusId
          }, {
            focus: false
          });
        }
        focusId = e.features[0].id;
        map.setFeatureState({
          'source': 'composite',
          'sourceLayer': 'boundaries_admin_1',
          id: focusId
        }, {
          focus: true
        });
      }

      // If joined data exists
      if (e.features[0].state.hasOwnProperty('code')) {

        console.log(e.features)

        map.fitBounds(statesLookup[e.features[0].state.code].bounds, {
          padding: 20
        })

        // Populate map overlay
        const rows = filteredData.filter(d => statesLookup[d.State].boundary_id == e.features[0].id)

        var description = `<b>${e.features[0].state.name}</b>`;
        description += '<ul>';
        rows.forEach(d => description += `<li>${d["Date of Declaration"]} - ${d.Entity}</li>`)
        description += '</ul>';
        document.getElementById('declarations').innerHTML = description;

      } else {
        // document.getElementById('map-overlay').innerHTML = 'No resolutions recorded in state';
      }

    }

    function createLocationPopup(e) {

      var coordinates = e.lngLat;

      // Ensure that if the map is zoomed out such that
      // multiple copies of the feature are visible, the
      // popup appears over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      new mapboxgl.Popup()
        .setLngLat(e.features[0].geometry.coordinates)
        .setHTML(locationPopupHTML(e.features[0]))
        .addTo(map);

    }

    function statePopupHTML(feature) {

      var description;

      if (feature.state.hasOwnProperty('name')) {


        description = `<b>${feature.state.name}</b>`;
        description += `<p><b>${feature.state.count}</b> declarations</p>`;
      } else {
        description = 'none'
      }
      return description;
    }

    function locationPopupHTML(feature) {

      var description;

      description = `<b>${feature.properties.Entity}</b><hr style="margin:4px 0">`;
      description += `<p>${feature.properties.Declaration}</p><hr style="margin:4px 0">`;
      description +=
        `<i><a href='${feature.properties.Link}' target="_blank">Declared on ${feature.properties["Date of Declaration"]}</a></i>`;

      return description;
    }


    //
    // Utility
    //

    // Returns an array of map style layers that match a given filter function
    function findLayers(map, filterFn) {
      return map.getStyle().layers.filter(layer => {
        return filterFn ? filterFn(layer) : layer;
      });
    }

    // Set layer source
    function setLayerSource(layerId, sourceId) {

      let styleLayers = map.getStyle().layers;

      styleLayers.forEach((layer, idx) => {

        // Find template layer ids that begin with ~
        if (layer.id.includes(layerId)) {

          // Hide the template layer
          map.setLayoutProperty(layer.id, "visibility", "none")

          // Copy the layer properties and update the source
          let addLayer = Object.assign(layer, {
            id: layer.id.substring(1),
            source: sourceId
          })
          delete addLayer["source-layer"]

          // Add layer at the same position
          map.addLayer(addLayer, "~" + layer.id)
        }
      })

    }

    //
    // Data
    //

    function buildStateDropdown() {

      const stateDropdown = document.getElementById("state")
      for (var state in statesLookup) {

        const stateOption = document.createElement("option");
        stateOption.text = statesLookup[state].name;
        stateOption.value = state;
        stateDropdown.add(stateOption);

      }
    }


    buildStateDropdown()

  </script>


</body>