<head>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

  <link href="app.css" rel="stylesheet" />

  <script src="https://unpkg.com/geojson@0.5.0/geojson.min.js"></script>
  <script src="https://d3js.org/d3-dsv.v2.min.js"></script>
  <script src="https://d3js.org/d3-fetch.v2.min.js"></script>
  <script src="https://d3js.org/d3-array.v2.min.js"></script>

  <style>
    body {
      margin: 0;
    }

    article {
      margin: 200px auto;
      position: relative;
      width: 800px;
      border: 1px solid #eaeaea
    }

    section {
      position: relative;
    }


    #map {
      height: 100vh;
      width: 100%;
    }

    #map-filter {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      padding: 10px;
      color: grey;
      background-color: aliceblue;
      width: 100%;
    }
  </style>
</head>

<body>


  <article>
    <h1 class="page-title">Declarations of Racism as a Public Health Issue</h1>
    <p>Across the country, local and state leaders are declaring racism a public health crisis or emergency. These
      declarations are an important first step in the movement to advance racial equity and justice and must be followed
      by allocation of resources and strategic action.
    </p>

    <h4>Map of declaring institutions</h2>

      <section>
        <div id="map"></div>
        <div id="map-filter">
        </div>

      </section>

      <div id="map-overlay">
        Click location for resoltion details
      </div>
  </article>

  <script>
    //
    // Settings
    //

    // Map
    mapboxgl.accessToken = 'pk.eyJ1IjoicGxhbmVtYWQiLCJhIjoiemdYSVVLRSJ9.g3lbg_eN0kztmsfIPxa9MQ';

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/planemad/ckgd3vmjp17yp19s927o8bior',
      center: [-100, 40],
      zoom: 2
    });

    // Define map bounds 
    var bounds = [
      [-200, -10], // [west, south]
      [-30, 80] // [east, north]
    ];
    // Set the map's max bounds.
    map.setMaxBounds(bounds);

    // Spreadsheet
    var sheetId = "1syyiY3LnE_RgAQmvhGqwBFM_eky_E2gbHjisGLDvUd0";
    var sheetName = "All";
    var sheetData = null;

    //
    //  Map logic
    //

    map.on("load", function () {

      loadMapLayers();
      addMapInteractions();

    });

    //
    // Map style
    //

    function loadMapLayers() {


      map.addLayer({
        'id': 'US states outline',
        'type': 'line',
        'source': 'composite',
        'source-layer': 'boundaries_admin_1',
        'layout': {},
        'paint': {
          'line-width': 0.5,
          'line-color': [
            'case',
            ['boolean', ['feature-state', 'focus'], false],
            "hsl(207, 64%, 58%)",
            ['boolean', ['feature-state', 'hover'], false],
            "hsl(207, 64%, 58%)",
            'rgba(0,0,0,0)'
          ]
        },
        'filter': ["all", [
            "any",
            [
              "==",
              "all",
              ["get", "worldview"]
            ],
            [
              "in",
              "US",
              ["get", "worldview"]
            ]
          ],
          [
            "==",
            "US",
            ["get", "iso_3166_1"]
          ]
        ]
      });

      map.setPaintProperty("US-states-fill", "fill-color", [
        "case",
        [
          "!=",
          null,
          ["feature-state", "count"]
        ],
        [
          "interpolate",
          ["linear"],
          [
            "feature-state",
            "count"
          ],
          1,
          "#feffc9",
          30,
          "#ff9700"
        ],
        "#efefef"
      ])


      // Location points

      map.addSource('locations', {
        type: 'geojson',
        'data': null
      });

      let styleLayers = map.getStyle().layers;

      map.setLayoutProperty("locations", "visibility", "none")
      map.setLayoutProperty("locations-label", "visibility", "none")

      let layer, addLayer;

      layer = styleLayers.filter(d => d.id == "locations")[0]
      addLayer = Object.assign(layer, {
        id: "locations-circle"
      })
      map.addLayer(addLayer)

      layer = styleLayers.filter(d => d.id == "locations-label")[0]
      addLayer = Object.assign(layer, {
        id: "locations-labels"
      })
      map.addLayer(addLayer)




      // Load spreadsheet

      loadSheetData();

    }


    function loadSheetData() {

      d3.csv(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`)
        .then(function (data) {

          sheetData = data;

          // Convert rows into a geojson and add as points
          const geojson = GeoJSON.parse(data, {
            Point: ['Latitude', 'Longitude']
          });

          map.getSource('locations').setData(geojson)

          var bbox = turf.bbox(geojson);
          map.fitBounds(bbox, {
            padding: 50
          });

          // Aggregate rows by type
          var typesData = d3.group(data, d => d.Type)
          typesData.forEach((d, i) => {
            const checkbox =
              `<input checked type="checkbox" id="${i}" name="${i}" value="${i}"><label for="${i}">${i} (${d.length})</label>`

            document.getElementById('map-filter').insertAdjacentHTML('beforeend', checkbox);
          })

          document.getElementById('map-filter').insertAdjacentHTML('beforeend', "<br>");

          // Aggregate rows by subtype
          var subTypesData = d3.group(data, d => d["Sub-Type"])
          subTypesData.forEach((d, i) => {
            const checkbox =
              `<input checked type="checkbox" id="${i}" name="${i}" value="${i}"><label for="${i}">${i} (${d.length})</label>`

            document.getElementById('map-filter').insertAdjacentHTML('beforeend', checkbox);
          })


          // Aggregate rows by state and join to boundaries
          var statesData = d3.group(data, d => d.State)

          // Iterate over entries for each state
          statesData.forEach((d, i) => {

            map.setFeatureState({
              'source': 'composite',
              'sourceLayer': 'boundaries_admin_1',
              id: boundaries_us_adm1[i].boundary_id
            }, {
              count: d.length,
              name: boundaries_us_adm1[i].name
            });

          })

        })
    }

    //
    // Interactions
    //

    const hoverPopup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false,
      offset: {
        "top": [0, 10],
        "bottom": [0, -10]
      }
    });

    function addMapInteractions() {


      map.on('mousemove', 'US-states-fill', createStatePopup);
      map.on('mouseleave', 'US-states-fill', removeStatePopup);


      // inspect a cluster on click
      /*   map.on('click', 'clusters', function(e) {
          var features = map.queryRenderedFeatures(e.point, {
            layers: ['clusters']
          });
          var clusterId = features[0].properties.cluster_id;
          map.getSource('locations').getClusterExpansionZoom(
            clusterId,
            function(err, zoom) {
              if (err) return;
        
              map.easeTo({
                center: features[0].geometry.coordinates,
                zoom: zoom
              });
            }
          );
        }); */
      map.on('click', 'locations-label', createLocationPopup)

      map.on('click', 'US-states-fill', focusState);

    }

    var hoverId = null;

    function createStatePopup(e) {

      map.getCanvas().style.cursor = 'pointer';


      if (e.features.length > 0) {
        if (hoverId) {
          map.setFeatureState({
            'source': 'composite',
            'sourceLayer': 'boundaries_admin_1',
            id: hoverId
          }, {
            hover: false
          });
        }
        hoverId = e.features[0].id;
        map.setFeatureState({
          'source': 'composite',
          'sourceLayer': 'boundaries_admin_1',
          id: hoverId
        }, {
          hover: true
        });
      }


      var coordinates = e.lngLat;

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      // Populate the popup and set its coordinates
      // based on the feature found.
      hoverPopup.remove();
      if (statePopupHTML(e.features[0]) !== "none") {

        hoverPopup
          .setLngLat(coordinates)
          .setHTML(statePopupHTML(e.features[0]))
          .addTo(map);
      }

    }

    function removeStatePopup() {
      map.getCanvas().style.cursor = '';
      hoverPopup.remove();

      if (hoverId) {
        map.setFeatureState({
          'source': 'composite',
          'sourceLayer': 'boundaries_admin_1',
          id: hoverId
        }, {
          hover: false
        });
      }
      hoverId = null;

    }

    var focusId = null;

    function focusState(e) {


      if (e.features.length > 0) {


        if (focusId) {
          map.setFeatureState({
            'source': 'composite',
            'sourceLayer': 'boundaries_admin_1',
            id: focusId
          }, {
            focus: false
          });
        }
        focusId = e.features[0].id;
        map.setFeatureState({
          'source': 'composite',
          'sourceLayer': 'boundaries_admin_1',
          id: focusId
        }, {
          focus: true
        });


      }

      // If joined data exists
      if (e.features[0].state.hasOwnProperty('name')) {

        map.easeTo({
          center: e.lngLat,
          zoom: 6.1
        })

        // Populate map overlay
        const rows = sheetData.filter(d => d.map_state_id == e.features[0].id)

        var description = `<b>${e.features[0].state.name}</b>`;
        description += '<ul>';
        rows.forEach(d => description += `<li>${d.Entity}</li>`)
        description += '</ul>';
        document.getElementById('map-overlay').innerHTML = description;

      } else {
        // document.getElementById('map-overlay').innerHTML = 'No resolutions recorded in state';
      }


    }

    function createLocationPopup(e) {

      var coordinates = e.lngLat;

      // Ensure that if the map is zoomed out such that
      // multiple copies of the feature are visible, the
      // popup appears over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(locationPopupHTML(e.features[0]))
        .addTo(map);

    }

    function statePopupHTML(feature) {

      var description;

      if (feature.state.hasOwnProperty('name')) {
        description = `<h3>${feature.state.name}</h3>`;
        description += `<p><b>${feature.state.count}</b> resolutions on record</p>`;
      } else {
        description = 'none'
      }
      return description;
    }

    function locationPopupHTML(feature) {

      var description;

      description = `<h3>${feature.properties.Entity}<br><small>${feature.properties.map_state_name}</small></h3>`;
      description += ``;
      description += `<p><a href='${feature.properties.Link}'>Resolutions</a> passed</p>`;

      return description;
    }


    //
    // Utility
    //

    // Returns an array of map style layers that match a given filter function
    function findLayers(map, filterFn) {
      return map.getStyle().layers.filter(layer => {
        return filterFn ? filterFn(layer) : layer;
      });
    }

    let boundaries_us_adm1 = {
      "AL": {
        "code": "AL",
        "boundary_id": "70377",
        "name": "Alabama"
      },
      "AK": {
        "code": "AK",
        "boundary_id": "135913",
        "name": "Alaska"
      },
      "AZ": {
        "code": "AZ",
        "boundary_id": "201449",
        "name": "Arizona"
      },
      "AR": {
        "code": "AR",
        "boundary_id": "266985",
        "name": "Arkansas"
      },
      "CA": {
        "code": "CA",
        "boundary_id": "332521",
        "name": "California"
      },
      "CO": {
        "code": "CO",
        "boundary_id": "398057",
        "name": "Colorado"
      },
      "CT": {
        "code": "CT",
        "boundary_id": "463593",
        "name": "Connecticut"
      },
      "DE": {
        "code": "DE",
        "boundary_id": "529129",
        "name": "Delaware"
      },
      "DC": {
        "code": "DC",
        "boundary_id": "594665",
        "name": "District of Columbia"
      },
      "FL": {
        "code": "FL",
        "boundary_id": "660201",
        "name": "Florida"
      },
      "GA": {
        "code": "GA",
        "boundary_id": "725737",
        "name": "Georgia"
      },
      "HI": {
        "code": "HI",
        "boundary_id": "791273",
        "name": "Hawaii"
      },
      "ID": {
        "code": "ID",
        "boundary_id": "856809",
        "name": "Idaho"
      },
      "IL": {
        "code": "IL",
        "boundary_id": "922345",
        "name": "Illinois"
      },
      "IN": {
        "code": "IN",
        "boundary_id": "987881",
        "name": "Indiana"
      },
      "IA": {
        "code": "IA",
        "boundary_id": "1053417",
        "name": "Iowa"
      },
      "KS": {
        "code": "KS",
        "boundary_id": "1118953",
        "name": "Kansas"
      },
      "KY": {
        "code": "KY",
        "boundary_id": "1184489",
        "name": "Kentucky"
      },
      "LA": {
        "code": "LA",
        "boundary_id": "1250025",
        "name": "Louisiana"
      },
      "ME": {
        "code": "ME",
        "boundary_id": "1315561",
        "name": "Maine"
      },
      "MD": {
        "code": "MD",
        "boundary_id": "1381097",
        "name": "Maryland"
      },
      "MA": {
        "code": "MA",
        "boundary_id": "1446633",
        "name": "Massachusetts"
      },
      "MI": {
        "code": "MI",
        "boundary_id": "1512169",
        "name": "Michigan"
      },
      "MN": {
        "code": "MN",
        "boundary_id": "1577705",
        "name": "Minnesota"
      },
      "MS": {
        "code": "MS",
        "boundary_id": "1643241",
        "name": "Mississippi"
      },
      "MO": {
        "code": "MO",
        "boundary_id": "1708777",
        "name": "Missouri"
      },
      "MT": {
        "code": "MT",
        "boundary_id": "1774313",
        "name": "Montana"
      },
      "NE": {
        "code": "NE",
        "boundary_id": "1839849",
        "name": "Nebraska"
      },
      "NV": {
        "code": "NV",
        "boundary_id": "1905385",
        "name": "Nevada"
      },
      "NH": {
        "code": "NH",
        "boundary_id": "1970921",
        "name": "New Hampshire"
      },
      "NJ": {
        "code": "NJ",
        "boundary_id": "2036457",
        "name": "New Jersey"
      },
      "NM": {
        "code": "NM",
        "boundary_id": "2101993",
        "name": "New Mexico"
      },
      "NY": {
        "code": "NY",
        "boundary_id": "2167529",
        "name": "New York"
      },
      "NC": {
        "code": "NC",
        "boundary_id": "2233065",
        "name": "North Carolina"
      },
      "ND": {
        "code": "ND",
        "boundary_id": "2298601",
        "name": "North Dakota"
      },
      "OH": {
        "code": "OH",
        "boundary_id": "2364137",
        "name": "Ohio"
      },
      "OK": {
        "code": "OK",
        "boundary_id": "2429673",
        "name": "Oklahoma"
      },
      "OR": {
        "code": "OR",
        "boundary_id": "2495209",
        "name": "Oregon"
      },
      "PA": {
        "code": "PA",
        "boundary_id": "2560745",
        "name": "Pennsylvania"
      },
      "RI": {
        "code": "RI",
        "boundary_id": "2626281",
        "name": "Rhode Island"
      },
      "SC": {
        "code": "SC",
        "boundary_id": "2691817",
        "name": "South Carolina"
      },
      "SD": {
        "code": "SD",
        "boundary_id": "2757353",
        "name": "South Dakota"
      },
      "TN": {
        "code": "TN",
        "boundary_id": "2822889",
        "name": "Tennessee"
      },
      "TX": {
        "code": "TX",
        "boundary_id": "2888425",
        "name": "Texas"
      },
      "UT": {
        "code": "UT",
        "boundary_id": "2953961",
        "name": "Utah"
      },
      "VT": {
        "code": "VT",
        "boundary_id": "3019497",
        "name": "Vermont"
      },
      "VA": {
        "code": "VA",
        "boundary_id": "3085033",
        "name": "Virginia"
      },
      "WA": {
        "code": "WA",
        "boundary_id": "3150569",
        "name": "Washington"
      },
      "WV": {
        "code": "WV",
        "boundary_id": "3216105",
        "name": "West Virginia"
      },
      "WI": {
        "code": "WI",
        "boundary_id": "3281641",
        "name": "Wisconsin"
      },
      "WY": {
        "code": "WY",
        "boundary_id": "3347177",
        "name": "Wyoming"
      }
    }
  </script>


</body>